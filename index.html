<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø·ÙØ§Ù„ - Ø®Ø¯Ù…Ø© Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø£Ø­Ø¯</title>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, getDocs, query, where, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCpA-BlpWt16KjpuDrSGPw27zwK-xR4mtc",
    authDomain: "dmetebtada2y.firebaseapp.com",
    projectId: "dmetebtada2y",
    storageBucket: "dmetebtada2y.firebasestorage.app",
    messagingSenderId: "909175641895",
    appId: "1:909175641895:web:a0f89addf1cc9f6bf7fb02",
    measurementId: "G-5R1QL94EMH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.onload = async () => {
    const stageDropdown = document.getElementById("stageDropdown");
    const classDropdown = document.getElementById("classDropdown");
    const form = document.getElementById("kidsForm");
    const childDOB = document.getElementById("childDOB");

    // ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯
    childDOB.min = "2018-01-01";
    childDOB.max = "2021-12-31";

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§ Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹
    const yearsSnapshot = await getDocs(collection(db, "years"));
    const years = [];
    yearsSnapshot.forEach(doc => {
      years.push({ id: doc.id, name: doc.data().name });
    });
    years.sort((a,b) => a.name.localeCompare(b.name));
    years.forEach(y => {
      const option = document.createElement("option");
      option.value = y.id;
      option.textContent = y.name;
      stageDropdown.appendChild(option);
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØµÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø© + ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ
    stageDropdown.addEventListener("change", async () => {
      classDropdown.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>`;
      if (!stageDropdown.value) return;

      const classesSnapshot = await getDocs(collection(db, "classes"));
      const filtered = [];
      classesSnapshot.forEach(doc => {
        if (doc.data().yearId === stageDropdown.value) {
          filtered.push({ id: doc.id, name: doc.data().name });
        }
      });
      filtered.sort((a,b) => a.name.localeCompare(b.name));
      filtered.forEach(c => {
        const option = document.createElement("option");
        option.value = c.id;
        option.textContent = c.name;
        classDropdown.appendChild(option);
      });
    });

    // Submit form + validation + Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const childName = document.getElementById("childName").value.trim();
      const dob = childDOB.value;
      const parentPhone = document.getElementById("parentPhone").value.trim();
      const parentName = document.getElementById("parentName").value.trim();
      const stageId = stageDropdown.value;
      const classId = classDropdown.value;

      if (!stageId || !classId || !childName || !dob || !parentPhone || !parentName) {
        Swal.fire({
          title: 'ØªÙ†Ø¨ÙŠÙ‡ âš ï¸',
          html: 'Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!<br>Ù„Ù„ØªÙˆØ§ØµÙ„: <a href="https://www.facebook.com/5dmetEbted2y.ST.Marya" target="_blank">ØµÙØ­Ø© Ø®Ø¯Ù…Ø© Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø£Ø­Ø¯</a>',
          icon: 'warning',
          confirmButtonColor: '#ff6b81'
        });
        return;
      }

      if (childName.split(" ").length < 3 || parentName.split(" ").length < 3) {
        Swal.fire({
          title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³Ù… âœï¸',
          html: 'ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„<br>Ù„Ù„ØªÙˆØ§ØµÙ„: <a href="https://www.facebook.com/5dmetEbted2y.ST.Marya" target="_blank">ØµÙØ­Ø© Ø§Ù„Ø®Ø¯Ù…Ø©</a>',
          icon: 'error',
          confirmButtonColor: '#ff6b81'
        });
        return;
      }

      const phonePattern = /^(010|011|012|015)[0-9]{8}$/;
      if (!phonePattern.test(parentPhone)) {
        Swal.fire({
          title: 'Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­ ğŸ“',
          html: 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ±ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 010/011/012/015 ÙˆÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù…<br>Ù„Ù„ØªÙˆØ§ØµÙ„: <a href="https://www.facebook.com/5dmetEbted2y.ST.Marya" target="_blank">ØµÙØ­Ø© Ø§Ù„Ø®Ø¯Ù…Ø©</a>',
          icon: 'error',
          confirmButtonColor: '#ff6b81'
        });
        return;
      }

      const kidsRef = collection(db, "kids");
      const q = query(kidsRef, 
        where("childName", "==", childName),
        where("classId", "==", classId)
      );
      const existing = await getDocs(q);
      if (!existing.empty) {
        Swal.fire({
          title: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ âš ï¸',
          html: 'Ù‡Ø°Ø§ Ø§Ù„Ø·ÙÙ„ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„.<br>Ù„Ù„ØªÙˆØ§ØµÙ„: <a href="https://www.facebook.com/5dmetEbted2y.ST.Marya" target="_blank">ØµÙØ­Ø© Ø§Ù„Ø®Ø¯Ù…Ø©</a>',
          icon: 'info',
          confirmButtonColor: '#ff6b81'
        });
        return;
      }

      const data = {
        stageId,
        stageName: stageDropdown.options[stageDropdown.selectedIndex].text,
        classId,
        className: classDropdown.options[classDropdown.selectedIndex].text,
        childName,
        childDOB: dob,
        parentPhone,
        parentName,
        createdAt: new Date().toISOString()
      };

      await addDoc(kidsRef, data);

      Swal.fire({
        title: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰',
        html: `Ø´ÙƒØ±Ø§Ù‹ ${parentName} Ù„ØªØ³Ø¬ÙŠÙ„ ${childName}!<br>Ù„Ù„ØªÙˆØ§ØµÙ„: <a href="https://www.facebook.com/5dmetEbted2y.ST.Marya" target="_blank">ØµÙØ­Ø© Ø§Ù„Ø®Ø¯Ù…Ø©</a>`,
        icon: 'success',
        confirmButtonColor: '#ff6b81',
        backdrop: `
          rgba(0,0,123,0.3)
          url("https://media.giphy.com/media/5GoVLqeAOo6PK/giphy.gif")
          left top
          no-repeat
        `
      });

      form.reset();
      classDropdown.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>`;
    });
  };
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
* {box-sizing: border-box;}
body {
  font-family: 'Cairo', sans-serif;
  background: linear-gradient(135deg, #FFEEF2, #D0FFF6);
  margin: 0;
  padding: 0;
}
.container {
  max-width: 650px; /* Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
  width: 90%;       /* Ù…Ù†Ø§Ø³Ø¨ Ù„ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª */
  margin: 30px auto;
  background: #fff;
  border-radius: 30px;
  padding: 40px 30px;
  text-align: center;
  box-shadow: 0 15px 50px rgba(0,0,0,0.2);
  animation: fadeIn 1s ease-in-out;
}
.logo img {
  width: 120px;
  height: auto;
  margin-bottom: 15px;
  animation: bounce 3s infinite ease-in-out;
}
@keyframes fadeIn {0% {opacity:0; transform: translateY(50px);} 100% {opacity:1; transform: translateY(0);}}
.logo svg {width: 120px; margin-bottom: 20px; animation: bounce 3s infinite ease-in-out;}
@keyframes bounce {0%,100%{transform:translateY(0);}50%{transform:translateY(-15px);}}
h1 {color:#FF6B81; margin-bottom:25px; font-size:28px;}
select, input {
  width: 100%;
  padding: 14px;
  margin: 10px 0;
  border-radius: 20px;
  border: 2px solid #FFD1DC;
  font-size: 16px;
  outline: none;
  transition: 0.3s;
}
select:focus, input:focus {border-color:#FF6B81; box-shadow: 0 0 10px rgba(255,107,129,0.4);}
button {
  background: linear-gradient(45deg,#FF6B81,#FF8F6B);
  color:#fff; padding:16px; font-size:20px; border:none; border-radius:25px;
  cursor:pointer; margin-top:15px; width:100%; transition:0.4s; box-shadow:0 10px 25px rgba(255,107,129,0.4);
}
button:hover {transform:scale(1.05); box-shadow:0 12px 30px rgba(255,107,129,0.5);}
.footer {text-align:center; margin-top:20px; color:#777; font-size:14px;}
@media(max-width:650px){
  .container{padding:25px 20px;} 
  h1{font-size:24px;} 
  button{font-size:18px;}
}
</style>
</head>

<body>
<div class="container">
   <div class="logo">
    <img src="logo.png" alt="Ø®Ø¯Ù…Ø© Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ">
  </div>

  <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø·ÙØ§Ù„ - Ø®Ø¯Ù…Ø© Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø£Ø­Ø¯</h1>
  <form id="kidsForm">
    <select id="stageDropdown">
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
    </select>
    <select id="classDropdown">
      <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>
    </select>
    <input type="text" id="childName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ Ø«Ù„Ø§Ø«ÙŠ" required>
    <input type="date" id="childDOB" placeholder="ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯ Ø§Ù„Ø·ÙÙ„" required>
    <input type="text" id="parentPhone" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" required>
    <input type="text" id="parentName" placeholder="Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø«Ù„Ø§Ø«ÙŠ" required>
    <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·ÙÙ„ ğŸˆ</button>
  </form>
  <div class="footer">
    ÙƒÙ†ÙŠØ³Ø© Ø§Ù„Ù‚Ø¯ÙŠØ³Ø© Ø§Ù„Ø¹Ø°Ø±Ø§Ø¡ Ù…Ø±ÙŠÙ… - Ø§Ù„ÙƒÙØ´Ù‘Ø­ ğŸ’’
  </div>
</div>
</body>
</html>
