<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل الأطفال - خدمة مدارس الأحد</title>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, getDocs, query, where, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCpA-BlpWt16KjpuDrSGPw27zwK-xR4mtc",
    authDomain: "dmetebtada2y.firebaseapp.com",
    projectId: "dmetebtada2y",
    storageBucket: "dmetebtada2y.firebasestorage.app",
    messagingSenderId: "909175641895",
    appId: "1:909175641895:web:a0f89addf1cc9f6bf7fb02",
    measurementId: "G-5R1QL94EMH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.onload = async () => {
    const stageDropdown = document.getElementById("stageDropdown");
    const classDropdown = document.getElementById("classDropdown");
    const form = document.getElementById("kidsForm");
    const childDOB = document.getElementById("childDOB");

    // تحديد تاريخ الميلاد
    childDOB.min = "2018-01-01";
    childDOB.max = "2021-12-31";

    // تحميل المراحل وترتيبها أبجدياً
    const yearsSnapshot = await getDocs(collection(db, "years"));
    const years = [];
    yearsSnapshot.forEach(doc => {
      years.push({ id: doc.id, name: doc.data().name });
    });
    years.sort((a,b) => a.name.localeCompare(b.name));
    years.forEach(y => {
      const option = document.createElement("option");
      option.value = y.id;
      option.textContent = y.name;
      stageDropdown.appendChild(option);
    });

    // تحديث الفصول حسب المرحلة + ترتيب أبجدي
    stageDropdown.addEventListener("change", async () => {
      classDropdown.innerHTML = `<option value="">اختر الفصل</option>`;
      if (!stageDropdown.value) return;

      const classesSnapshot = await getDocs(collection(db, "classes"));
      const filtered = [];
      classesSnapshot.forEach(doc => {
        if (doc.data().yearId === stageDropdown.value) {
          filtered.push({ id: doc.id, name: doc.data().name });
        }
      });
      filtered.sort((a,b) => a.name.localeCompare(b.name));
      filtered.forEach(c => {
        const option = document.createElement("option");
        option.value = c.id;
        option.textContent = c.name;
        classDropdown.appendChild(option);
      });
    });

    // Submit form + validation + حماية من التكرار
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const childName = document.getElementById("childName").value.trim();
      const dob = childDOB.value;
      const parentPhone = document.getElementById("parentPhone").value.trim();
      const parentName = document.getElementById("parentName").value.trim();
      const stageId = stageDropdown.value;
      const classId = classDropdown.value;

      if (!stageId || !classId || !childName || !dob || !parentPhone || !parentName) {
        Swal.fire({
          title: 'تنبيه ⚠️',
          html: 'من فضلك اكمل جميع البيانات!<br>للتواصل: <a href="https://www.facebook.com/5dmetEbted2y.ST.Marya" target="_blank">صفحة خدمة مدارس الأحد</a>',
          icon: 'warning',
          confirmButtonColor: '#ff6b81'
        });
        return;
      }

      if (childName.split(" ").length < 3 || parentName.split(" ").length < 3) {
        Swal.fire({
          title: 'خطأ في الاسم ✏️',
          html: 'يجب كتابة الاسم ثلاثي على الأقل<br>للتواصل: <a href="https://www.facebook.com/5dmetEbted2y.ST.Marya" target="_blank">صفحة الخدمة</a>',
          icon: 'error',
          confirmButtonColor: '#ff6b81'
        });
        return;
      }

      const phonePattern = /^(010|011|012|015)[0-9]{8}$/;
      if (!phonePattern.test(parentPhone)) {
        Swal.fire({
          title: 'رقم غير صحيح 📞',
          html: 'الرقم المصري يجب أن يبدأ بـ 010/011/012/015 ويكون 11 رقم<br>للتواصل: <a href="https://www.facebook.com/5dmetEbted2y.ST.Marya" target="_blank">صفحة الخدمة</a>',
          icon: 'error',
          confirmButtonColor: '#ff6b81'
        });
        return;
      }

      const kidsRef = collection(db, "kids");
      const q = query(kidsRef, 
        where("childName", "==", childName),
        where("classId", "==", classId)
      );
      const existing = await getDocs(q);
      if (!existing.empty) {
        Swal.fire({
          title: 'تم التسجيل مسبقاً ⚠️',
          html: 'هذا الطفل مسجل بالفعل في هذا الفصل.<br>للتواصل: <a href="https://www.facebook.com/5dmetEbted2y.ST.Marya" target="_blank">صفحة الخدمة</a>',
          icon: 'info',
          confirmButtonColor: '#ff6b81'
        });
        return;
      }

      const data = {
        stageId,
        stageName: stageDropdown.options[stageDropdown.selectedIndex].text,
        classId,
        className: classDropdown.options[classDropdown.selectedIndex].text,
        childName,
        childDOB: dob,
        parentPhone,
        parentName,
        createdAt: new Date().toISOString()
      };

      await addDoc(kidsRef, data);

      Swal.fire({
        title: 'تم التسجيل بنجاح 🎉',
        html: `شكراً ${parentName} لتسجيل ${childName}!<br>للتواصل: <a href="https://www.facebook.com/5dmetEbted2y.ST.Marya" target="_blank">صفحة الخدمة</a>`,
        icon: 'success',
        confirmButtonColor: '#ff6b81',
        backdrop: `
          rgba(0,0,123,0.3)
          url("https://media.giphy.com/media/5GoVLqeAOo6PK/giphy.gif")
          left top
          no-repeat
        `
      });

      form.reset();
      classDropdown.innerHTML = `<option value="">اختر الفصل</option>`;
    });
  };
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
* {box-sizing: border-box;}
body {
  font-family: 'Cairo', sans-serif;
  background: linear-gradient(135deg, #FFEEF2, #D0FFF6);
  margin: 0;
  padding: 0;
}
.container {
  max-width: 650px; /* مناسب للشاشات الكبيرة */
  width: 90%;       /* مناسب لكل الشاشات */
  margin: 30px auto;
  background: #fff;
  border-radius: 30px;
  padding: 40px 30px;
  text-align: center;
  box-shadow: 0 15px 50px rgba(0,0,0,0.2);
  animation: fadeIn 1s ease-in-out;
}
.logo img {
  width: 120px;
  height: auto;
  margin-bottom: 15px;
  animation: bounce 3s infinite ease-in-out;
}
@keyframes fadeIn {0% {opacity:0; transform: translateY(50px);} 100% {opacity:1; transform: translateY(0);}}
.logo svg {width: 120px; margin-bottom: 20px; animation: bounce 3s infinite ease-in-out;}
@keyframes bounce {0%,100%{transform:translateY(0);}50%{transform:translateY(-15px);}}
h1 {color:#FF6B81; margin-bottom:25px; font-size:28px;}
select, input {
  width: 100%;
  padding: 14px;
  margin: 10px 0;
  border-radius: 20px;
  border: 2px solid #FFD1DC;
  font-size: 16px;
  outline: none;
  transition: 0.3s;
}
select:focus, input:focus {border-color:#FF6B81; box-shadow: 0 0 10px rgba(255,107,129,0.4);}
button {
  background: linear-gradient(45deg,#FF6B81,#FF8F6B);
  color:#fff; padding:16px; font-size:20px; border:none; border-radius:25px;
  cursor:pointer; margin-top:15px; width:100%; transition:0.4s; box-shadow:0 10px 25px rgba(255,107,129,0.4);
}
button:hover {transform:scale(1.05); box-shadow:0 12px 30px rgba(255,107,129,0.5);}
.footer {text-align:center; margin-top:20px; color:#777; font-size:14px;}
@media(max-width:650px){
  .container{padding:25px 20px;} 
  h1{font-size:24px;} 
  button{font-size:18px;}
}
</style>
</head>

<body>
<div class="container">
   <div class="logo">
    <img src="logo.png" alt="خدمة إبتدائي">
  </div>

  <h1>تسجيل الأطفال - خدمة مدارس الأحد</h1>
  <form id="kidsForm">
    <select id="stageDropdown">
      <option value="">اختر المرحلة</option>
    </select>
    <select id="classDropdown">
      <option value="">اختر الفصل</option>
    </select>
    <input type="text" id="childName" placeholder="اسم الطفل ثلاثي" required>
    <input type="date" id="childDOB" placeholder="تاريخ ميلاد الطفل" required>
    <input type="text" id="parentPhone" placeholder="رقم واتساب ولي الأمر" required>
    <input type="text" id="parentName" placeholder="اسم ولي الأمر ثلاثي" required>
    <button type="submit">تسجيل الطفل 🎈</button>
  </form>
  <div class="footer">
    كنيسة القديسة العذراء مريم - الكُشّح 💒
  </div>
</div>
</body>
</html>
